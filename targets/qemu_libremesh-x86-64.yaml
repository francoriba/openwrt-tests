# QEMU x86-64 target for LibreMesh testing with virtualized WiFi (vwifi/mac80211_hwsim)
#
# This target enables testing LibreMesh features in a virtualized mesh network.
# It requires:
#   - A LibreMesh firmware image built for x86-64
#   - vwifi-server running on the host
#   - vwifi-client binary to be uploaded to the VM
#
# Usage:
#   make tests/x86-64-libremesh FIRMWARE=/path/to/libremesh-x86-64.img

targets:
  main:
    features: [hwsim, libremesh]
    resources:
      - NetworkService:
          # The actual address will be filled in by the strategy
          address: ""
          port: 22
          username: root

    drivers:
      - QEMUDriver:
          qemu_bin: qemu_bin
          machine: pc
          cpu: max
          memory: 128M
          extra_args: "-device virtio-rng-pci -netdev user,id=wan -device virtio-net-pci,netdev=wan"
          nic: "user,model=virtio-net-pci,net=10.13.0.0/16,id=lan"
          disk: firmware
      - ShellDriver:
          login_prompt: Please press Enter to activate this console.
          prompt: 'root@'
          await_login_timeout: 30
          username: root
      - SSHDriver:
          username: root
          explicit_scp_mode: True
      - QEMUNetworkStrategy: {}

tools:
  qemu_bin: qemu-system-x86_64

imports:
  - ../strategies/qemunetworkstrategy.py
